# Ethernaut Level

This directory contains the source for a forthcoming [Ethernaut](https://ethernaut.openzeppelin.com/) level called "Upsidedown Engineer". In this level, only the deployed bytecode for the contract is available. The goal is to take ownership of the contract.

This level is intended to show that contracts without underlying source code are **not** safe from being exploited. There are numerous tools out there that can assist with exploiting contract given only the bytecode. Two real-life examples where contracts were exploited without any underlying Solidity code include:

- TransitSwap
    - https://rekt.news/transit-swap-rekt/
- MEV Bot
    - https://rekt.news/ripmevbot/
    - https://quillaudits.medium.com/earned-1m-lost-1-5m-dark-forest-of-mev-bots-8cd1dc17258c

## Level Description
The code for a contract is not always publicly available but that doesn't mean you can't hack it! In this level only the deployed bytecode is available. Your job is to become the `owner` of the contract.

Things that might help:
- Take a look at the contract on a block explorer
- The Vault level

The level has the following bytecode:
```
0x608060405234801561001057600080fd5b5060008054336001600160a01b03199182168117909255600180549091169091179055604080514260208201526100
5f910160408051601f198184030181529190528051602090910120610092565b6040518060600160405280603b8152602001610768603b9139805161008c9160
02916020909101906100fa565b506101ce565b600061009c6100a3565b9190915550565b6000806040516020016100dc906020808252601290820152712a3432
9029b7b63aba34b7b71034b9901a1960711b604082015260600190565b60408051601f19818403018152919052805160209091012092915050565b8280546101
0690610193565b90600052602060002090601f016020900481019282610128576000855561016e565b82601f1061014157805160ff191683800117855561016e
565b8280016001018555821561016e579182015b8281111561016e578251825591602001919060010190610153565b5061017a92915061017e565b5090565b5b
8082111561017a576000815560010161017f565b600181811c908216806101a757607f821691505b602082108114156101c857634e487b7160e01b6000526022
60045260246000fd5b50919050565b61058b806101dd6000396000f3fe6080604052600436106100555760003560e01c8063100000011461005a578063123456
781461008d57806313af4035146100a25780634e71e0c8146100c25780638da5cb5b146100d75780638f32d59b1461010f575b600080fd5b3480156100665760
0080fd5b5061007a6100753660046103e1565b610140565b6040519081526020015b60405180910390f35b6100a061009b3660046103fa565b6101b0565b005b
3480156100ae57600080fd5b506100a06100bd36600461041c565b610264565b3480156100ce57600080fd5b506100a06102f5565b3480156100e357600080fd
5b506000546100f7906001600160a01b031681565b6040516001600160a01b039091168152602001610084565b34801561011b57600080fd5b50610130600054
6001600160a01b0316331490565b6040519015158152602001610084565b600060038211156101a1575080600061015a60028361044c565b6101659060016104
6e565b90505b8181101561019b57905080600281610180818661044c565b61018a919061046e565b610194919061044c565b9050610168565b50919050565b81
156101ab575060015b919050565b6101b8610378565b8214156102285760006101ca33610140565b9050808214156101eb57600080546001600160a01b031916
33179055505050565b7f7e4c830d27ef9b1819f6c1710f43e650db84477e9efee4c78342793292f56a23600260405161021b9190610494565b60405180910390
a1505050565b7f7e4c830d27ef9b1819f6c1710f43e650db84477e9efee4c78342793292f56a2360026040516102589190610494565b60405180910390a15050
565b6000546001600160a01b031633146102d65760405162461bcd60e51b815260206004820152602b60248201527f4d617962652074686520636c61696d4f77
6e6572736869702066756e6374696f60448201526a6e2077696c6c20776f726b60a81b606482015260840160405180910390fd5b600080546001600160a01b03
19166001600160a01b0383161790555b50565b600080546001600160a01b031916331781556001546040805163fbf552db60e01b815290516001600160a01b03
929092169263fbf552db9260048084019360209390839003909101908290875af1158015610354573d6000803e3d6000fd5b505050506040513d601f19601f82
0116820180604052508101906102f2919061053c565b60008061038361038a565b5492915050565b6000806040516020016103c3906020808252601290820152
712a34329029b7b63aba34b7b71034b9901a1960711b604082015260600190565b60408051601f19818403018152919052805160209091012092915050565b60
00602082840312156103f357600080fd5b5035919050565b6000806040838503121561040d57600080fd5b50508035926020909101359150565b600060208284
03121561042e57600080fd5b81356001600160a01b038116811461044557600080fd5b9392505050565b60008261046957634e487b7160e01b60005260126004
5260246000fd5b500490565b6000821982111561048f57634e487b7160e01b600052601160045260246000fd5b500190565b6000602080835260008454816001
82811c9150808316806104b657607f831692505b8583108114156104d457634e487b7160e01b85526022600452602485fd5b8786018381526020018180156104
f157600181146105025761052d565b60ff1986168252878201965061052d565b60008b81526020902060005b8681101561052757815484820152908501908901
61050e565b83019750505b50949998505050505050505050565b60006020828403121561054e57600080fd5b505191905056fea2646970667358221220317b0a
43fd3aaea01389813d5da5631f2e493512567663a8f7db717dfa1e1a6664736f6c634300080a003354727920746f2066696e64206f757420776861742073746f
7261676520736c6f742074686520736f6c7574696f6e2069732073746f72656420696e
```

## Solution
<details>
  <summary>Spoiler Warning!</summary>

  The `UpsidedownEngineer` contract contains a function:
  
  ```solidity
  function solve_108B1F57E(uint256 _a, uint256 _b) public payable {
      if (_a == get_a()) {
          uint256 sqrt = sqrt_215F58CF9(uint256(uint160(msg.sender)));
          if (_b == sqrt) {
              owner = msg.sender;
          } else {
              emit Hint(hint_3);
          }
      } else {
          emit Hint(hint_3);
      }
  }
  ```

  that must be called with the correct input values to solve the level. Calling this function with the incorrect input will emit an event that contains a hint.

  - This function has function selector `0x12345678`.
  - The input value for `_a` should be set to the value at storage slot `keccak256(abi.encode("The Solution is 42"))`
  - The input value for `_b` should be set to the value of `sqrt_215F58CF9(uint256(uint160(msg.sender)))` where the  `sqrt_215F58CF9` function has function selector `0x10000001`.

  Hints will be given at various stages of solving the level:

  - The level description will suggest decompiling on Etherscan
  - After decompiling on Etherscan, a hint "Maybe the claimOwnership function will work" in the `setOwner` function will be visible in the decompiled code
  - Calling the `claimOwnership` function will revert with the hint "Try out https://library.dedaub.com/decompile"
  - Decompiling using https://library.dedaub.com/decompile will result in a much simpler decompilation. The level should be solvable at this point by calling the function with selector `0x12345678` with the correct input.
  - If the incorrect input is supplied, a `Hint` event will be emitted with message "Try to find out what storage slot the solution is stored in".
</details>

## Factory
- The `UpsidedownEngineerFactory` contract has been deployed on the Goerli testnet at: [0xC27383f1b53BC1A03F54Fa202349ee8C3Bdfdbd1](https://goerli.etherscan.io/address/0xC27383f1b53BC1A03F54Fa202349ee8C3Bdfdbd1).
- In order to not reveal the source of the contract, the factory contract used for creating new level instances will deploy the contract from its bytecode (i.e. it won't use `new UpsidedownEngineer()` as this would reveal the source). Instead, assembly is used to deploy the deploy an instance of the `UpsidedownEngineer` contract directly from its bytecode:
    ```{solidity}
    // Result of solc --bin contracts/UpsidedownEngineer.sol
    bytes memory bytecode = hex"608060405234801561001057600080fd5b5060008054336001600160a01b031991821681179092556001805490911690911790556040805142602082015261005f910160408051601f198184030181529190528051602090910120610092565b6040518060600160405280603b8152602001610768603b9139805161008c916002916020909101906100fa565b506101ce565b600061009c6100a3565b9190915550565b6000806040516020016100dc906020808252601290820152712a34329029b7b63aba34b7b71034b9901a1960711b604082015260600190565b60408051601f19818403018152919052805160209091012092915050565b82805461010690610193565b90600052602060002090601f016020900481019282610128576000855561016e565b82601f1061014157805160ff191683800117855561016e565b8280016001018555821561016e579182015b8281111561016e578251825591602001919060010190610153565b5061017a92915061017e565b5090565b5b8082111561017a576000815560010161017f565b600181811c908216806101a757607f821691505b602082108114156101c857634e487b7160e01b600052602260045260246000fd5b50919050565b61058b806101dd6000396000f3fe6080604052600436106100555760003560e01c8063100000011461005a578063123456781461008d57806313af4035146100a25780634e71e0c8146100c25780638da5cb5b146100d75780638f32d59b1461010f575b600080fd5b34801561006657600080fd5b5061007a6100753660046103e1565b610140565b6040519081526020015b60405180910390f35b6100a061009b3660046103fa565b6101b0565b005b3480156100ae57600080fd5b506100a06100bd36600461041c565b610264565b3480156100ce57600080fd5b506100a06102f5565b3480156100e357600080fd5b506000546100f7906001600160a01b031681565b6040516001600160a01b039091168152602001610084565b34801561011b57600080fd5b506101306000546001600160a01b0316331490565b6040519015158152602001610084565b600060038211156101a1575080600061015a60028361044c565b61016590600161046e565b90505b8181101561019b57905080600281610180818661044c565b61018a919061046e565b610194919061044c565b9050610168565b50919050565b81156101ab575060015b919050565b6101b8610378565b8214156102285760006101ca33610140565b9050808214156101eb57600080546001600160a01b03191633179055505050565b7f7e4c830d27ef9b1819f6c1710f43e650db84477e9efee4c78342793292f56a23600260405161021b9190610494565b60405180910390a1505050565b7f7e4c830d27ef9b1819f6c1710f43e650db84477e9efee4c78342793292f56a2360026040516102589190610494565b60405180910390a15050565b6000546001600160a01b031633146102d65760405162461bcd60e51b815260206004820152602b60248201527f4d617962652074686520636c61696d4f776e6572736869702066756e6374696f60448201526a6e2077696c6c20776f726b60a81b606482015260840160405180910390fd5b600080546001600160a01b0319166001600160a01b0383161790555b50565b600080546001600160a01b031916331781556001546040805163fbf552db60e01b815290516001600160a01b03929092169263fbf552db9260048084019360209390839003909101908290875af1158015610354573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906102f2919061053c565b60008061038361038a565b5492915050565b6000806040516020016103c3906020808252601290820152712a34329029b7b63aba34b7b71034b9901a1960711b604082015260600190565b60408051601f19818403018152919052805160209091012092915050565b6000602082840312156103f357600080fd5b5035919050565b6000806040838503121561040d57600080fd5b50508035926020909101359150565b60006020828403121561042e57600080fd5b81356001600160a01b038116811461044557600080fd5b9392505050565b60008261046957634e487b7160e01b600052601260045260246000fd5b500490565b6000821982111561048f57634e487b7160e01b600052601160045260246000fd5b500190565b600060208083526000845481600182811c9150808316806104b657607f831692505b8583108114156104d457634e487b7160e01b85526022600452602485fd5b8786018381526020018180156104f157600181146105025761052d565b60ff1986168252878201965061052d565b60008b81526020902060005b868110156105275781548482015290850190890161050e565b83019750505b50949998505050505050505050565b60006020828403121561054e57600080fd5b505191905056fea2646970667358221220317b0a43fd3aaea01389813d5da5631f2e493512567663a8f7db717dfa1e1a6664736f6c634300080a003354727920746f2066696e64206f757420776861742073746f7261676520736c6f742074686520736f6c7574696f6e2069732073746f72656420696e";

    assembly {
        addr := create(0, add(bytecode, 0x20), mload(bytecode))
        if iszero(extcodesize(addr)) {
            revert(0, 0)
        }
    }
    ```
- A new instance of the `UpsidedownEngineer` contract can be deployed by calling the `deploy` function on the `UpsidedownEngineerFactory` contract.
